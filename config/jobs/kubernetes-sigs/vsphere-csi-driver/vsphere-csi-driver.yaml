presubmits:
  kubernetes-sigs/vsphere-csi-driver:

  # Runs "gofmt", "go vet", and "golint" on the sources.
  - name: pull-vsphere-csi-driver-check
    decorate: true
    branches:
    - ^master$
    path_alias: sigs.k8s.io/vsphere-csi-driver
    skip_submodules: true
    always_run: true
    skip_report: false
    spec:
      containers:
      - image: gcr.io/cloud-provider-vsphere/csi-ci:b23178d9
        command:
        - "make"
        args:
        - "check"
    annotations:
      testgrid-dashboards: vmware-presubmits-vsphere-csi-driver
      testgrid-alert-email: k8s-testing-cloud-provider-vsphere+alerts@groups.vmware.com

  # Runs 'shellcheck' on appropriate sources
  - name: pull-vsphere-csi-driver-verify-shell
    always_run: false
    run_if_changed: '.*\.\w*sh$'
    decorate: true
    path_alias: sigs.k8s.io/vsphere-csi-driver
    spec:
      containers:
      - image: gcr.io/cluster-api-provider-vsphere/extra/shellcheck:v0.6.0
        command:
        - /bin/shellcheck.sh
    annotations:
      testgrid-dashboards: vmware-presubmits-vsphere-csi-driver
      testgrid-tab-name: pr-verify-shell
      testgrid-alert-email: k8s-testing-cloud-provider-vsphere+alerts@groups.vmware.com
      description: Verifies the shell scripts have been linted

  # Runs 'mdlint' on appropriate sources
  - name: pull-vsphere-csi-driver-verify-markdown
    always_run: false
    run_if_changed: '.*\.md$'
    decorate: true
    path_alias: sigs.k8s.io/vsphere-csi-driver
    spec:
      containers:
      - image: gcr.io/cluster-api-provider-vsphere/extra/mdlint:0.17.0
        command:
        - /nodejs/bin/node
        args:
        - /md/lint
        - .
    annotations:
      testgrid-dashboards: vmware-presubmits-vsphere-csi-driver
      testgrid-tab-name: pr-verify-markdown
      testgrid-alert-email: k8s-testing-cloud-provider-vsphere+alerts@groups.vmware.com
      description: Verifies the markdown has been linted

  # Builds the CSI binary
  - name: pull-vsphere-csi-driver-build
    decorate: true
    branches:
    - ^master$
    path_alias: sigs.k8s.io/vsphere-csi-driver
    skip_submodules: true
    always_run: true
    skip_report: false
    spec:
      containers:
      - image: gcr.io/cloud-provider-vsphere/csi-ci:b23178d9
        command:
        - "make"
        args:
        - "build"
    annotations:
      testgrid-dashboards: vmware-presubmits-vsphere-csi-driver
      testgrid-alert-email: k8s-testing-cloud-provider-vsphere+alerts@groups.vmware.com

  # Executes the unit tests.
  - name: pull-vsphere-csi-driver-unit-test
    decorate: true
    branches:
    - ^master$
    path_alias: sigs.k8s.io/vsphere-csi-driver
    skip_submodules: true
    always_run: true
    skip_report: false
    spec:
      containers:
      - image: gcr.io/cloud-provider-vsphere/csi-ci:b23178d9
        command:
        - "make"
        args:
        - "unit-test"
    annotations:
      testgrid-dashboards: vmware-presubmits-vsphere-csi-driver
      testgrid-alert-email: k8s-testing-cloud-provider-vsphere+alerts@groups.vmware.com

postsubmits:
  kubernetes-sigs/vsphere-csi-driver:

  # Deploys the CSI image
  - name: post-vsphere-csi-driver-deploy
    decorate: true
    labels:
      preset-dind-enabled: "true"
      preset-kind-volume-mounts: "true"
      preset-cloud-provider-vsphere-e2e-config: "true"
    max_concurrency: 1
    branches:
    - ^master$
    path_alias: sigs.k8s.io/vsphere-csi-driver
    skip_submodules: true
    spec:
      containers:
      - image: gcr.io/cloud-provider-vsphere/csi-ci:b23178d9
        command:
        - "make"
        args:
        - "deploy"
        securityContext:
          privileged: true
    annotations:
      testgrid-dashboards: vmware-postsubmits-vsphere-csi-driver
      testgrid-num-columns-recent: '20'
      testgrid-alert-email: k8s-testing-cloud-provider-vsphere+alerts@groups.vmware.com
