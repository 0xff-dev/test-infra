- publisher:
    name: gcs-uploader
    publishers:
        - postbuildscript:
            builders:
                - shell: |
                    mkdir -p _tmp
                    curl -fsS --retry 3 "https://raw.githubusercontent.com/kubernetes/kubernetes/master/hack/jenkins/upload-to-gcs.sh" > ./_tmp/upload-to-gcs.sh
                    chmod +x ./_tmp/upload-to-gcs.sh
                - conditional-step:
                    condition-kind: current-status
                    condition-worst: SUCCESS
                    condition-best: SUCCESS
                    steps:
                        - shell: 'JENKINS_BUILD_FINISHED=SUCCESS ./_tmp/upload-to-gcs.sh'
                - conditional-step:
                    condition-kind: current-status
                    condition-worst: UNSTABLE
                    condition-best: UNSTABLE
                    steps:
                        - shell: 'JENKINS_BUILD_FINISHED=UNSTABLE ./_tmp/upload-to-gcs.sh'
                - conditional-step:
                    condition-kind: current-status
                    condition-worst: FAILURE
                    condition-best: FAILURE
                    steps:
                        - shell: 'JENKINS_BUILD_FINISHED=FAILURE ./_tmp/upload-to-gcs.sh'
                - conditional-step:
                    condition-kind: current-status
                    condition-worst: ABORTED
                    condition-best: ABORTED
                    steps:
                        - shell: 'JENKINS_BUILD_FINISHED=ABORTED ./_tmp/upload-to-gcs.sh'
            script-only-if-succeeded: False
            script-only-if-failed: False
        # Use the plugin for the build log, since it isn't available on Jenkins slaves.
        - google-cloud-storage:
            credentials-id: kubernetes-jenkins-pull
            uploads:
                - build-log:
                    log-name: build-log.txt
                    storage-location: gs://kubernetes-jenkins/pr-logs/pull/${ghprbPullId}/${JOB_NAME}/${BUILD_NUMBER}
                    share-publicly: true
                    upload-for-failed-jobs: true
